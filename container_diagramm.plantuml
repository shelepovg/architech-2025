@startuml
!include <C4/C4_Context>
!include <C4/C4_Container>

title Контейнерная диаграмма системы цифровых платежей

Person(physical_client, "Физическое лицо", "Клиент системы")
Person(legal_client, "Юридическое лицо", "Бизнес-клиент")

System_Boundary(payment_system, "Цифровая платежная система") {
    Container(mobile_app, "Мобильное приложение", "iOS/Android", "Предоставляет интерфейс для работы с цифровым рублем")
    Container(web_app, "Веб-приложение", "React/Angular", "Веб-версия для управления платежами")
    Container(spa, "SPA-клиент", "JavaScript", "Админ-панель для юр.лиц")
    Container(auth_service, "Сервис аутентификации", "Keycloak/OAuth2", "Обеспечивает авторизацию и аутентификацию")
    Container(payment_api, "Платежный API", "Java/Spring", "Ядро системы: обработка транзакций")
    Container(wallet_service, "Сервис кошельков", "Kotlin", "Управление цифровыми кошельками")
    Container(account_service, "Сервис счетов", "Java", "Работа с клиентскими счетами")
    Container(reporting_service, "Отчетный сервис", "Python", "Генерация отчетов")
    
    ContainerDb(main_db, "Основная БД", "PostgreSQL", "Хранит данные клиентов, транзакций, счетов")
    ContainerDb(dwh, "Хранилище данных", "ClickHouse", "Аналитические данные и история")
    ContainerDb(bi_db, "BI-хранилище", "Microsoft SQL Server", "Данные для бизнес-аналитики")
    Container(bi_tool, "BI-система", "Power BI", "Визуализация аналитики")
}

System_Ext(bank, "Банк-посредник", "API банковской системы")
System_Ext(cbr, "ЦБ РФ", "API цифрового рубля")

' Связи между контейнерами
Rel(physical_client, mobile_app, "Использует", "HTTPS")
Rel(physical_client, web_app, "Использует", "HTTPS")
Rel(legal_client, spa, "Использует", "HTTPS")

Rel(mobile_app, auth_service, "Аутентификация", "OAuth2")
Rel(web_app, auth_service, "Аутентификация", "OAuth2")
Rel(spa, auth_service, "Аутентификация", "OAuth2")

Rel(mobile_app, payment_api, "API вызовы", "REST/JSON")
Rel(web_app, payment_api, "API вызовы", "REST/JSON")
Rel(spa, payment_api, "API вызовы", "REST/JSON")

Rel(payment_api, wallet_service, "Внутренние вызовы", "gRPC")
Rel(payment_api, account_service, "Внутренние вызовы", "gRPC")
Rel(payment_api, reporting_service, "Запрос отчетов", "REST")

Rel(wallet_service, main_db, "Чтение/запись", "JDBC")
Rel(account_service, main_db, "Чтение/запись", "JDBC")
Rel(payment_api, main_db, "Чтение/запись", "JDBC")

Rel(reporting_service, dwh, "Загрузка данных", "ETL")
Rel(dwh, bi_db, "Экспорт данных", "ETL")
Rel(bi_tool, bi_db, "Анализ данных", "ODBC")

Rel(payment_api, bank, "Проведение платежей", "ISO 8583")
Rel(payment_api, cbr, "Операции с ЦФР", "API ЦБ РФ")

@enduml